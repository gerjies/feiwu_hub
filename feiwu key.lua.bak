local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local player = Players.LocalPlayer
local playerGui = player.PlayerGui

-- ======================== 配置区域 ========================
local CONFIG = {
    -- 默认有效卡密列表（如远程获取失败时使用）
    VALID_KEYS = {
        "ACGCQJaB2a44TKaRTmb1M8FKKXCp0X3SLD9", "ACGz74DUUk6HJi3ugIrsJH0jbz4wueevNX7",
        "ACG0Gda8Prz5bWGjG7ogXsXUEOziewOpcKY", "ACGQBWwaVKNXnK9dZWcifXE2lRPtv2WvZgQ",
        "ACGFGkcpeMKMr4WklMWqP2DyLFi5zv5QRCJ", "ACGfU5bgS3lEt5soTc67BIti5HIWnhnow8e",
        "ACG89uwvkbzi9UnnaUKPGBPXb8FajqUr81e", "ACGMsofS3BdkWHspuh1chLbWCRQU0nmTA0u",
        "ACGUC2x4Pg1iaS6BeuMNhFfU06okuNeF5g3", "ACGsQfPr1reGUCtrljBoBe5aBhUkfE7MDnE",
        "ACGoiRsriUTj7glk0oJ5HeijhT6vB6kuLYL", "ACGHA2NbnG8jXK1Dr62J5C6ivdsz25O5Fn5",
        "ACGuSyyQwpUFbHXTLEQ2P7ZYIJnya74go3x", "ACG5GemwvJLM1oEdOZsdqeXbliZKsVGQymz",
        "ACGos1Foex8rMXhbIjEmdOFYmLr8DjF8o3b", "ACGbtINswjkTQwPPi0Edbv64HrBeZDI88dL",
        "ACGpuveS8D4pWDvZaf4Jou685rkOx7nVeNU", "ACGYE1u9yUhvj46ilHHGZpXO9KjiQeRP7Rl",
        "ACGxbSf30vAbLhHad8qEzme1n0XEMeQcLbg", "ACG3rKP5El7Yeieyvngi2mAFOYUJkLp3K3U",
        "ACGQjrsNyQaOV4YpTbyJYm6t8P6h6xgb9B6", "ACGZWhHE71Q8udtEf0zbvHyNnlxnqoWzYsC",
        "ACGnWBWvRz0dubt76Np5FAX2KN3Uu1uIY3A", "ACG3P3ee0t9tue0hMQJvuEyp5o0ospsjmS2",
        "ACG7frSd9F7OkRr7TjHicb4oG1mhnD1mlkG", "ACGgqDGh6m0E8daEhBCJDzfArJ0a37AyP6v",
        "ACGUSu6Z105rIjEKGuLCTeVVNc316GMuIOU", "ACGgB2LbPQLj2G7duN0ozwk8MkaCjb9ZjPD",
        "ACGhH2Nc1E2J7fPQ8AtoTXfvL5xpjS4iien", "ACGOTXVsJJB47DGWGwp7qBOujK98IwmUHoI",
        "ACG4WVxKM2KLadd9k2t8BpU4pvXaQK71bSs", "ACG1npU7CUux9uu12zp0tNzG5ULlPax3bE3",
        "ACGr4D5q4Ob5s1aDlztw1wEOIR4g4GG6JWI", "ACGwZiFbEfQptcks4GtzJwyWm8LpT5bzmss",
        "ACGFEU1ZJBvs1m8mlBy8qOWPq6KthFUsoDP", "ACGWbDxx6hTnj9xQG1skTFTblqgIDxnluzp",
        "ACG8Hqnt2y64HfeS44DFhE5tVm8mhPUHK4h", "ACGbqfMR7FQBG71ewxG7BMv8rnbhYmOSE37",
        "ACGnqR485j4mX01AqebEwem23MxnjBnh3IF", "ACG4E1GXImVIwN11keVsYNGOvVabJp3DERY",
        "ACG8sOeXmi7HpLvkoRH3fhV5brMo7THrnYy", "ACG3Fi58MHnTXH3ynKjDTP75ZyEED7o4vqU",
        "ACGmrJYGhbSYHyQk5AetRTt1loBX0fjMn4H", "ACGXgqmM9Y87sARhdSbqfeFbNUtHWloKaDi",
        "ACGqApNTVzH4KMFs5i5hDRny8d64wHAGoID", "ACGsdx2GqeLbAgrmaXr0XbaiN847NT29ZaS",
        "ACGEBAgiGSdJZ3fM0y0IfnHiB9RZfse9wue", "ACG4vinJeCi6Ry559IIWf36cqKr23SWf4Ak",
        "ACGxWkcAzXSCSvzFWxrufn3pXzFyyuw6ewu", "ACGo9UD7Bk6MClYCp8VpKxTjtElaXTdubnQ",
        "ACG7iMNuQofKHGuEcAdVWxh6314WoSr8DDK", "ACGMpPea5uRJF601w3PgLaY0immjP0UZpPz",
        "ACGqExpfZJkdjRaMvO51gq64rv1SgXgbUOP", "ACGSNHFuajuMvpmRyBt0GY6Xfhc9PCStijI",
        "ACGEI2MBBoUhsheVjrgKrsFmjGpv7ZfBJ9Q", "ACGgmazkzsMdymXp9Nna3aRJut5hBCuaLdy",
        "ACG4aImomHM20alzJAE34TwJUjmQ30CLuCH", "ACGQwqqGCmXY9Kql4QykrFViMOv752BKMve",
        "ACGFSPrp9LH8YJaKSI6e6Jl0xCISrbFl713", "ACGdBW5ZZF7sJUnfpe16nXn2I0z5tgP0QG7",
        "ACGEIIgOIk2OyU6J4pplJBYxV9cura9sy7Q", "ACG4JN2EdlE7B8p4Pz09dnn4rlcFKOGdi7s",
        "ACGFTFzZcd2vcGC0qmoeESHTWbuUubU0Db6", "ACG5qGRHK6HZ6gv7Kz3716MVabNbYahlX0D",
        "ACGpwCNfj6Nihl6zK5CdKdqJXUxSCALn7uX", "ACGGFoXHYuvs0L02HNcig1NjlJsxOTrXQIT",
        "ACGwxzTpBQ6jcqFTkMU8IlZaMDsO1gy4zkc", "ACGdpHu3X8wN8BXZS1DCgzrcdGiMASyZHSz",
        "ACGiv4N2kHWMJF2XUBzcLJtNbbqVMQTeSOX", "ACG0YYjAnUsTnCXEbW6e3XNcLkZsMd5IJ1C",
        "ACGh5LWkkuscXqNkW6A6t6SkFjnPyBAaEvc", "ACGSlqAzttH7Aint5gZY4TOa6dNanOhz0kO",
        "ACGpEjw66HjL257FfeCZd97LU5L359nIppE", "ACGgbAFkdhTrcTRxMxqArCWSwEepv5THU08",
        "ACG3jyoG1bOmD8OgpjAUJP1wAr9WsVChY6e", "ACGzM5DfpJXfFjG2r0pDOkk685lPK7PF75v",
        "ACGzeWX2CooF66XWmwvh5xjfTR7QPLGt0cN", "ACG7WZjdnWc0qgFyJmhSJ19EkvfwBB0QP8b",
        "ACGh13KfQNU6Wo8obB8a4aeyXN21XdbzsxY", "ACGnn50GqzTP0Rr6jEw57TtMPdjcGTgNrjK",
        "ACG8TfVXaZEkBsBlBT51v0hkMarLGAZUmeE", "ACGIeOy2TdF6nTymKpo8Z7Um54ACTEZwq22",
        "ACGXpPymJJ4aKjViNPZ44ZL8Omce8nCQPKH", "ACG9oG4UT9cV0mS42fN2ZYNNtAUnjVTD70l",
        "ACGv9LSEP0UNGFFTv8N7NphQ2hFHiLCaHsz", "ACGEidG7vFTXGq1NXG09yBDd7yFxOU1c4oj",
        "ACGabillUkP6NESyUEzZammls8m2EyEqgVN", "ACG1C3nhgMNCaB4Y2WPODmDdOeQMnPx3AjP",
        "ACGnqKwM5raEt4gQIjL7KUrC83HPu8FTPaC", "ACGgKzKlL8B7KsPb76mTr72GmcF3obIYF7A",
        "ACG5BUc9EzD0L8rMgGPFl6x2s3IHYCGh7DL", "ACGXgZr9ARNhJwpzZBHejFztN2fAPuSc5vc",
        "ACGHVWodm4nj9DOEl2agV10CAhIakERloHf", "ACGIc7FiRN9bLLcVcDb7kLf2m7lLv9ZpT2S",
        "ACGiYi1NQpODcVXiDI2LWJgYKwvEcNUGKh5", "ACGa0DiEHGKuzHhZlGgoGROdUu0TLa7qa3P",
        "ACGNbMoKNQ52lo0SCd4CWdFCFMzu013kHg1", "ACGdrYS0IEji8Xf9qfjOw6A0M0baQ2OCnO5",
        "ACGmXvhjlh1l1XrnvMMJULoYeswVBQZUDIJ", "ACGZMFy3Xfy13O8HaX4pmKWodOfp1M0vHUX"
    },
    -- 最大验证尝试次数
    MAX_ATTEMPTS = 3,
    -- 授权信息本地存储路径
    SAVE_PATH = "AuthSystem/ValidUser.json",
    -- 远程获取有效卡密的URL
    VALID_KEYS_URL = "http://server.enet.online:23524/get_valid_keys", -- 请替换为您的实际URL
    -- 验证成功后执行的脚本
    TARGET_SCRIPT_URL = "https://raw.githubusercontent.com/gerjies/feiwu_hub/refs/heads/main/feiwu.lua",
    -- 管理员用户名
    ADMIN_USER = "gdhdfghffgh7"
}

-- ======================== 日志系统 ========================
local ActionLogs = {}
local LogDisplayLabel -- 提前声明引用

local function AddLog(msg, level)
    level = level or "INFO"
    local timestamp = os.date("%H:%M:%S")
    local formattedMsg = string.format("[%s] [%s] %s", timestamp, level, msg)
    
    table.insert(ActionLogs, formattedMsg)
    
    -- 打印到控制台
    if level == "WARN" then
        warn(formattedMsg)
    elseif level == "ERROR" then
        warn("ERROR: " .. formattedMsg)
    else
        print(formattedMsg)
    end
    
    -- 如果日志UI存在，更新显示
    if LogDisplayLabel then
        LogDisplayLabel.Text = table.concat(ActionLogs, "\n")
        -- 滚动到底部 (简单实现：调整CanvasPosition，但在纯TextLabel中较难，这里仅更新文本)
    end
end

-- ======================== 本地存储功能 ========================
-- 保存授权状态
local function SaveAuthStatus()
    pcall(function()
        if not isfolder("AuthSystem") then
            makefolder("AuthSystem")
        end
        local authData = {
            PlayerName = player.Name,
            Authorized = true,
            AuthTime = os.time(),
            ExpireTime = os.time() + 86400 * 7 -- 授权有效期7天
        }
        writefile(CONFIG.SAVE_PATH, HttpService:JSONEncode(authData))
    end)
end

-- 读取授权状态
local function LoadAuthStatus()
    if not isfile(CONFIG.SAVE_PATH) then return nil end
    local success, data = pcall(function()
        local content = readfile(CONFIG.SAVE_PATH)
        return HttpService:JSONDecode(content)
    end)
    if success and data then
        return data.Authorized and data.ExpireTime > os.time() and data.PlayerName == player.Name
    end
    return false
end

-- ======================== UI创建 ========================
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "KeyAuthUI"
ScreenGui.Parent = playerGui
ScreenGui.ResetOnSpawn = false

local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Parent = ScreenGui
MainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 30)
MainFrame.Position = UDim2.new(0.5, -130, 0.5, -80)
MainFrame.Size = UDim2.new(0, 260, 0, 160)
MainFrame.BackgroundTransparency = 0.1
MainFrame.Visible = false
MainFrame.Active = true
MainFrame.Draggable = true

local TitleBar = Instance.new("Frame")
TitleBar.Name = "TitleBar"
TitleBar.Parent = MainFrame
TitleBar.BackgroundColor3 = Color3.fromRGB(30, 40, 60)
TitleBar.Size = UDim2.new(1, 0, 0, 30)

local TitleLabel = Instance.new("TextLabel")
TitleLabel.Name = "TitleLabel"
TitleLabel.Parent = TitleBar
TitleLabel.BackgroundTransparency = 1
TitleLabel.Size = UDim2.new(1, 0, 1, 0)
TitleLabel.Text = "卡密验证"
TitleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
TitleLabel.TextSize = 16
TitleLabel.Font = Enum.Font.SourceSansBold

local KeyInput = Instance.new("TextBox")
KeyInput.Name = "KeyInput"
KeyInput.Parent = MainFrame
KeyInput.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
KeyInput.Position = UDim2.new(0.05, 0, 0.25, 0)
KeyInput.Size = UDim2.new(0.9, 0, 0, 40)
KeyInput.TextColor3 = Color3.fromRGB(255, 255, 255)
KeyInput.PlaceholderText = "输入卡密（区分大小写）"
KeyInput.PlaceholderColor3 = Color3.fromRGB(120, 120, 120)
KeyInput.TextSize = 14
KeyInput.ClearTextOnFocus = false

local VerifyBtn = Instance.new("TextButton")
VerifyBtn.Name = "VerifyBtn"
VerifyBtn.Parent = MainFrame
VerifyBtn.BackgroundColor3 = Color3.fromRGB(34, 197, 94)
VerifyBtn.Position = UDim2.new(0.1, 0, 0.6, 0)
VerifyBtn.Size = UDim2.new(0.8, 0, 0, 35)
VerifyBtn.Text = "验证并进入"
VerifyBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
VerifyBtn.TextSize = 14
VerifyBtn.Font = Enum.Font.SourceSansBold

local StatusLabel = Instance.new("TextLabel")
StatusLabel.Name = "StatusLabel"
StatusLabel.Parent = MainFrame
StatusLabel.BackgroundTransparency = 1
StatusLabel.Position = UDim2.new(0, 0, 0.85, 0)
StatusLabel.Size = UDim2.new(1, 0, 0, 20)
StatusLabel.Text = "请输入卡密"
StatusLabel.TextColor3 = Color3.fromRGB(180, 180, 180)
StatusLabel.TextSize = 12
StatusLabel.Font = Enum.Font.SourceSans


-- ======================== 管理员UI ========================
local ViewLogsBtn = Instance.new("TextButton")
ViewLogsBtn.Name = "ViewLogsBtn"
ViewLogsBtn.Parent = MainFrame
ViewLogsBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 80)
ViewLogsBtn.Position = UDim2.new(0.8, 0, 0, 5) -- 标题栏右侧
ViewLogsBtn.Size = UDim2.new(0, 45, 0, 20)
ViewLogsBtn.Text = "日志"
ViewLogsBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
ViewLogsBtn.TextSize = 12
ViewLogsBtn.Visible = true -- 默认显示，方便查看连接详情

local LogsFrame = Instance.new("ScrollingFrame")
LogsFrame.Name = "LogsFrame"
LogsFrame.Parent = ScreenGui
LogsFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 20)
LogsFrame.Position = UDim2.new(0.5, 140, 0.5, -80) -- 主窗口右侧
LogsFrame.Size = UDim2.new(0, 300, 0, 200)
LogsFrame.Visible = false
LogsFrame.CanvasSize = UDim2.new(0, 0, 0, 0) -- 自动调整
LogsFrame.AutomaticCanvasSize = Enum.AutomaticSize.Y

LogDisplayLabel = Instance.new("TextLabel")
LogDisplayLabel.Parent = LogsFrame
LogDisplayLabel.Size = UDim2.new(1, -10, 1, 0)
LogDisplayLabel.Position = UDim2.new(0, 5, 0, 0)
LogDisplayLabel.BackgroundTransparency = 1
LogDisplayLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
LogDisplayLabel.TextSize = 12
LogDisplayLabel.TextXAlignment = Enum.TextXAlignment.Left
LogDisplayLabel.TextYAlignment = Enum.TextYAlignment.Top
LogDisplayLabel.TextWrapped = true
LogDisplayLabel.Text = "等待日志..."

ViewLogsBtn.MouseButton1Click:Connect(function()
    LogsFrame.Visible = not LogsFrame.Visible
end)
-- ======================== 核心验证逻辑 ========================
local errorCount = 0
local isAuthorized = LoadAuthStatus()

local function ExecuteTargetScript()
    pcall(function()
        loadstring(game:HttpGet(CONFIG.TARGET_SCRIPT_URL))()
    end)
end

local function VerifyKey(inputKey, validKeys)
    for _, validKey in ipairs(validKeys) do
        if inputKey == validKey then
            return true
        end
    end
    return false
end

VerifyBtn.MouseButton1Click:Connect(function()
    local inputKey = KeyInput.Text
    -- 去除首尾空格，防止复制时多余空格导致错误
    inputKey = inputKey:gsub("^%s*(.-)%s*$", "%1")
    
    AddLog("尝试验证卡密: " .. inputKey)
    
    if errorCount >= CONFIG.MAX_ATTEMPTS then
        AddLog("验证失败次数过多，踢出玩家", "WARN")
        StatusLabel.Text = "尝试次数已达上限！"
        StatusLabel.TextColor3 = Color3.fromRGB(239, 68, 68)
        task.wait(1)
        player:Kick("多次输入错误卡密，已暂时封禁")
        return
    end
    if VerifyKey(inputKey, CONFIG.VALID_KEYS) then
        SaveAuthStatus()
        isAuthorized = true
        
        -- 验证成功，立即销毁界面，然后加载脚本
        if ScreenGui then ScreenGui:Destroy() end
        ExecuteTargetScript()
    else
        errorCount = errorCount + 1
        local remaining = CONFIG.MAX_ATTEMPTS - errorCount
        StatusLabel.Text = string.format("卡密无效，剩余%d次机会", remaining)
        StatusLabel.TextColor3 = Color3.fromRGB(239, 68, 68)
        KeyInput.Text = ""
    end
end)

-- ======================== 远程获取有效卡密 ========================

local function FetchValidKeys()
    AddLog("开始请求服务器获取卡密...")
    AddLog("目标 URL: " .. CONFIG.VALID_KEYS_URL)
    
    local success, response = pcall(function()
        local start = os.clock()
        -- 使用 game:HttpGet 替代 HttpService:GetAsync，因为后者常在客户端被禁用
        local res = game:HttpGet(CONFIG.VALID_KEYS_URL)
        AddLog(string.format("请求完成，耗时: %.2fs", os.clock() - start))
        return res
    end)
    
    if success then
        AddLog("服务器连接成功，响应长度: " .. #response)
        AddLog("响应内容预览: " .. string.sub(response, 1, 100) .. "...")
        
        local successDecode, keysData = pcall(function()
            return HttpService:JSONDecode(response)
        end)
        
        if successDecode and type(keysData) == "table" and keysData.validKeys then
            AddLog("JSON 解析成功，发现卡密数量: " .. #keysData.validKeys)
            return keysData.validKeys
        else
            AddLog("JSON 解析失败或格式错误", "ERROR")
            AddLog("原始数据: " .. tostring(response), "ERROR")
            return CONFIG.VALID_KEYS
        end
    else
        AddLog("连接服务器失败: " .. tostring(response), "ERROR")
        AddLog("将使用本地默认卡密列表", "WARN")
        return CONFIG.VALID_KEYS
    end
end

-- ======================== 启动授权检查 ========================
local function CheckAuthorization()
    -- 检查是否为管理员
    if player.Name == CONFIG.ADMIN_USER then
        AddLog("检测到管理员登录: " .. player.Name)
        ViewLogsBtn.Visible = true
    end

    if isAuthorized then
        AddLog("玩家已授权，直接进入: " .. player.Name)
        if ScreenGui then ScreenGui:Destroy() end
        ExecuteTargetScript()
        return
    end

    AddLog("未授权，正在获取服务器卡密列表...")
    local keys = FetchValidKeys()
    
    if keys and #keys > 0 then
        AddLog("成功同步卡密列表")
        CONFIG.VALID_KEYS = keys
    else
        AddLog("卡密同步失败，使用默认列表", "WARN")
    end
    
    StatusLabel.Text = "请输入卡密（卡密已由服务器同步）"
    MainFrame.Visible = true
end

-- 启动时检查授权
CheckAuthorization()

